name: Build Anjez Smart-Fixer

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Smart-Check & Fix Structure
        run: |
          # 1. فحص ملف settings.gradle
          if [ ! -f "settings.gradle" ]; then
            echo "Settings file missing! Creating default..."
            echo "include ':app'" > settings.gradle
          else
            echo "settings.gradle exists. Skipping..."
          fi

          # 2. فحص ملف gradle.properties وتفعيله لو ناقص
          if [ ! -f "gradle.properties" ]; then
            echo "gradle.properties missing! Creating with AndroidX enabled..."
            echo "android.useAndroidX=true" > gradle.properties
            echo "android.enableJetifier=true" >> gradle.properties
          else
            # لو الملف موجود بس مش مفعل الـ AndroidX، هنضيفها له
            if ! grep -q "android.useAndroidX=true" gradle.properties; then
              echo "Enabling AndroidX in existing gradle.properties..."
              echo "android.useAndroidX=true" >> gradle.properties
              echo "android.enableJetifier=true" >> gradle.properties
            else
              echo "AndroidX is already enabled in gradle.properties."
            fi
          fi

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.5

      - name: Build APK
        run: |
          gradle wrapper --gradle-version 8.5
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon

      - name: Upload Final APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Anjez-Smart-Build
          path: app/build/outputs/apk/debug/app-debug.apk
